# Tasks: Make Medio Fully Functional on Fly.io

**Feature**: Make Medio Fully Functional on Fly.io
**Branch**: `001-flyio-full-deployment`
**Date**: 2025-10-17
**Generated by**: /speckit.tasks

## Overview

This document contains actionable deployment tasks organized by user story priority. Each task follows the format:
`- [ ] [TaskID] [Priority] [Story] Description with file references`

**Total Tasks**: 35
**Task Categories**:
- P1 (Backend Operational): 12 tasks
- P2 (Auth Works): 11 tasks
- P3 (Core Features): 12 tasks

## Prerequisites Validation

Before starting deployment, verify these prerequisites are met:

- [X] [PREREQ-001] Verify flyctl CLI installed: `flyctl version`
- [X] [PREREQ-002] Authenticate with Fly.io: `flyctl auth login`
- [X] [PREREQ-003] Verify access to medio-backend app: `flyctl status -a medio-backend`
- [X] [PREREQ-004] Verify access to medio-react-app app: `flyctl status -a medio-react-app`
- [X] [PREREQ-005] Verify database exists: `flyctl status -a medio-backend-db`
- [X] [PREREQ-006] Obtain JWT_SECRET value from secure storage
- [X] [PREREQ-007] Obtain SENTRY_DSN value from Sentry dashboard

---

## User Story 1: Backend Service Operational (P1)

**Goal**: Start backend service and verify it's running correctly with database connectivity.

**Reference**: `specs/001-flyio-full-deployment/quickstart.md` Phase 1 (lines 16-84)

### Environment Configuration

- [X] [P1-001] P1 Story1 Set JWT_SECRET via `flyctl secrets set JWT_SECRET="<value>" -a medio-backend`
- [X] [P1-002] P1 Story1 Set SENTRY_DSN via `flyctl secrets set SENTRY_DSN="<value>" -a medio-backend`
- [X] [P1-003] P1 Story1 Verify secrets configured: `flyctl secrets list -a medio-backend`
- [X] [P1-004] P1 Story1 Validate backend/fly.toml contains NODE_ENV=production (line ~20)

### Database Migrations

- [X] [P1-005] P1 Story1 SSH into backend machine: `flyctl ssh console -a medio-backend`
- [X] [P1-006] P1 Story1 Navigate to app directory: `cd /app`
- [X] [P1-007] P1 Story1 Run migrations: `npm run migrate` (executes backend/src/db/migrate.js)
- [X] [P1-008] P1 Story1 Verify migration success in output: "Migrations completed successfully"
- [X] [P1-009] P1 Story1 Exit SSH session: `exit`

### Machine Startup

- [X] [P1-010] P1 Story1 List backend machines: `flyctl machines list -a medio-backend`
- [X] [P1-011] P1 Story1 Start first backend machine: `flyctl machines start <machine-id-1> -a medio-backend`
- [X] [P1-012] P1 Story1 Start second backend machine: `flyctl machines start <machine-id-2> -a medio-backend`

### Health Check Validation

- [X] [P1-013] P1 Story1 Monitor startup logs: `flyctl logs -a medio-backend` - watch for "Server started on port 5000"
- [X] [P1-014] P1 Story1 Check database connection in logs - watch for "Database connected successfully"
- [X] [P1-015] P1 Story1 Verify no environment variable errors in logs
- [X] [P1-016] P1 Story1 Test health endpoint: `curl https://medio-backend.fly.dev/`
- [X] [P1-017] P1 Story1 Validate health response format: `{"status":"ok","database":"connected","timestamp":"..."}`
- [X] [P1-018] P1 Story1 Check machine status: `flyctl status -a medio-backend` - both machines should show "started"
- [X] [P1-019] P1 Story1 Confirm health checks passing in flyctl status output

**P1 Validation Checklist** (from quickstart.md lines 77-83):
- [X] [P1-V01] Secrets configured (JWT_SECRET, SENTRY_DSN)
- [X] [P1-V02] Migrations ran successfully
- [X] [P1-V03] Both backend machines started
- [X] [P1-V04] Logs show successful database connection
- [X] [P1-V05] Health check endpoint returns 200 OK
- [X] [P1-V06] `flyctl status` shows machines healthy

---

## User Story 2: User Authentication Works (P2)

**Goal**: Verify frontend can communicate with backend and authentication flows work end-to-end.

**Reference**: `specs/001-flyio-full-deployment/quickstart.md` Phase 2 (lines 87-120)

### Frontend-Backend Connectivity

- [ ] [P2-001] P2 Story2 Check frontend status: `flyctl status -a medio-react-app`
- [ ] [P2-002] P2 Story2 Verify frontend machines showing "started" and healthy
- [ ] [P2-003] P2 Story2 Check frontend secrets: `flyctl secrets list -a medio-react-app`
- [ ] [P2-004] P2 Story2 Verify REACT_APP_API_URL points to https://medio-backend.fly.dev
- [ ] [P2-005] P2 Story2 Test frontend endpoint: `curl -I https://medio-react-app.fly.dev/`
- [ ] [P2-006] P2 Story2 Verify 200 OK response from frontend

### Browser Testing - Registration Flow

- [ ] [P2-007] P2 Story2 Open https://medio-react-app.fly.dev in browser
- [ ] [P2-008] P2 Story2 Verify login page loads within 3 seconds (SC-001)
- [ ] [P2-009] P2 Story2 Navigate to registration form and verify accessibility
- [ ] [P2-010] P2 Story2 Register new test account with valid email (e.g., test+deploy@example.com)
- [ ] [P2-011] P2 Story2 Verify registration success and redirect to dashboard
- [ ] [P2-012] P2 Story2 Confirm registration flow completes in under 2 minutes (SC-002)

### Browser Testing - Login Flow

- [ ] [P2-013] P2 Story2 Logout from test account
- [ ] [P2-014] P2 Story2 Login with test credentials
- [ ] [P2-015] P2 Story2 Verify session cookie is set (check browser DevTools → Application → Cookies)
- [ ] [P2-016] P2 Story2 Confirm cookie has httpOnly, Secure, and SameSite=Strict flags
- [ ] [P2-017] P2 Story2 Verify dashboard loads within 5 seconds after login (SC-003)
- [ ] [P2-018] P2 Story2 Refresh page and confirm session persists

### Error Handling Validation

- [ ] [P2-019] P2 Story2 Open browser DevTools console (F12)
- [ ] [P2-020] P2 Story2 Verify no console errors during login/registration flows
- [ ] [P2-021] P2 Story2 Verify error boundaries are working (no React component crashes visible)

**P2 Validation Checklist** (from quickstart.md lines 112-119):
- [ ] [P2-V01] Login page loads within 3 seconds
- [ ] [P2-V02] Registration form accessible
- [ ] [P2-V03] Can register new test account
- [ ] [P2-V04] Registration redirects to dashboard
- [ ] [P2-V05] Can login with test credentials
- [ ] [P2-V06] Session persists on page refresh
- [ ] [P2-V07] No console errors in browser DevTools

---

## User Story 3: Core Features Accessible (P3)

**Goal**: Verify dashboard, Kids Mode, and NFC functionality are accessible and functional.

**Reference**: `specs/001-flyio-full-deployment/quickstart.md` Phase 3 (lines 123-133)

### Dashboard Validation

- [ ] [P3-001] P3 Story3 Navigate to dashboard (should auto-redirect after login)
- [ ] [P3-002] P3 Story3 Verify dashboard displays user stats section
- [ ] [P3-003] P3 Story3 Check videos count displayed (0 for new account)
- [ ] [P3-004] P3 Story3 Check profiles count displayed (0 for new account)
- [ ] [P3-005] P3 Story3 Check NFC chips count displayed (0 for new account)
- [ ] [P3-006] P3 Story3 Verify no React Error Boundary crash screens

### Kids Mode Navigation

- [ ] [P3-007] P3 Story3 Navigate to /kids route via URL or navigation menu
- [ ] [P3-008] P3 Story3 Verify Kids Mode page loads without errors
- [ ] [P3-009] P3 Story3 Confirm NFC scanning interface renders
- [ ] [P3-010] P3 Story3 Check for "Scan your NFC chip" or similar prompt text
- [ ] [P3-011] P3 Story3 Verify no console errors specific to Kids Mode

### Video and Session Features

- [ ] [P3-012] P3 Story3 Navigate to videos section (if accessible without uploaded content)
- [ ] [P3-013] P3 Story3 Verify video upload interface is accessible
- [ ] [P3-014] P3 Story3 Check that session tracking endpoints are reachable (via network tab)
- [ ] [P3-015] P3 Story3 Verify heartbeat mechanism configured (check src/contexts/ or src/services/)

### Cross-Feature Console Validation

- [ ] [P3-016] P3 Story3 Review browser console for any errors across all navigation flows
- [ ] [P3-017] P3 Story3 Verify no crashed React components in any view
- [ ] [P3-018] P3 Story3 Check network tab for any failed API requests (should be 200 or expected 4xx)

**P3 Validation Checklist** (from quickstart.md lines 127-132):
- [ ] [P3-V01] Dashboard displays user stats (videos: 0, profiles: 0, NFC chips: 0)
- [ ] [P3-V02] Navigate to /kids → Kids Mode page loads
- [ ] [P3-V03] Kids Mode shows NFC scanning interface
- [ ] [P3-V04] No crashed React components (Error Boundary check)
- [ ] [P3-V05] No console errors for core navigation flows

---

## Post-Deployment Monitoring

**Reference**: `specs/001-flyio-full-deployment/quickstart.md` lines 189-220

### Health Check Monitoring (15 minutes)

- [ ] [MONITOR-001] Run continuous backend status check: `watch -n 5 flyctl status -a medio-backend`
- [ ] [MONITOR-002] Verify health checks pass 100% for 15 minutes (SC-006)
- [ ] [MONITOR-003] Monitor backend logs continuously: `flyctl logs -a medio-backend -f`
- [ ] [MONITOR-004] Monitor frontend logs continuously: `flyctl logs -a medio-react-app -f`
- [ ] [MONITOR-005] Watch for successful API requests in logs
- [ ] [MONITOR-006] Verify no 502/503 errors in logs (SC-007)
- [ ] [MONITOR-007] Check database query times under 500ms (SC-010)

### Sentry Monitoring

- [ ] [MONITOR-008] Visit Sentry dashboard (https://sentry.io)
- [ ] [MONITOR-009] Verify no errors reported from production environment
- [ ] [MONITOR-010] Check performance metrics for API response times

---

## Success Criteria Verification

**Reference**: `specs/001-flyio-full-deployment/spec.md` lines 143-155

Verify all 10 success criteria from specification:

- [ ] [SC-001] Login page loads within 3 seconds
- [ ] [SC-002] Can register account in under 2 minutes
- [ ] [SC-003] Dashboard accessible within 5 seconds after login
- [ ] [SC-004] Health check responds within 1 second
- [ ] [SC-005] Logs show zero database connection errors
- [ ] [SC-006] Health checks pass 100% for 15 minutes
- [ ] [SC-007] Zero 502/503 errors during testing
- [ ] [SC-008] Kids Mode loads without errors
- [ ] [SC-009] System handles 10 concurrent logins (load test)
- [ ] [SC-010] Database queries under 500ms (check logs)

---

## Rollback Procedure

**Reference**: `specs/001-flyio-full-deployment/quickstart.md` lines 223-237

If deployment fails and cannot be fixed:

- [ ] [ROLLBACK-001] List backend machines: `flyctl machines list -a medio-backend`
- [ ] [ROLLBACK-002] Stop first machine: `flyctl machines stop <machine-id-1> -a medio-backend`
- [ ] [ROLLBACK-003] Stop second machine: `flyctl machines stop <machine-id-2> -a medio-backend`
- [ ] [ROLLBACK-004] Capture error logs: `flyctl logs -a medio-backend > backend-error-logs.txt`
- [ ] [ROLLBACK-005] Investigate issues from captured logs
- [ ] [ROLLBACK-006] Document root cause and remediation plan
- [ ] [ROLLBACK-007] After fixing: restart from Phase 1 (P1 tasks)

---

## Troubleshooting Quick Reference

**Reference**: `specs/001-flyio-full-deployment/quickstart.md` lines 136-185

### Backend won't start
```bash
flyctl logs -a medio-backend
# Check for: missing secrets, database unreachable, migration failures
```

### Health checks failing
```bash
curl -v https://medio-backend.fly.dev/
# Check for: 503 response, database connection errors
```

### Frontend connection errors
```bash
flyctl logs -a medio-backend | grep CORS
# Verify: CORS allows https://medio-react-app.fly.dev
```

### Database connection issues
```bash
flyctl ssh console -a medio-backend
echo $DATABASE_URL
exit
# Verify: DATABASE_URL is injected automatically
```

---

## Task Execution Notes

1. **Sequential Execution**: Execute tasks in order within each user story. P1 must complete before P2, P2 before P3.

2. **Validation Gates**: Complete all validation checklists (P1-V*, P2-V*, P3-V*) before proceeding to next phase.

3. **Error Handling**: If any task fails, consult Troubleshooting section before proceeding. Do not skip failed tasks.

4. **Documentation**: Record actual machine IDs, timestamps, and any deviations from expected behavior in deployment log.

5. **Time Estimates**:
   - P1 (Backend Operational): 15-20 minutes
   - P2 (Auth Works): 10-15 minutes
   - P3 (Core Features): 10-15 minutes
   - Post-Deployment Monitoring: 15 minutes continuous
   - **Total**: ~60 minutes for complete deployment validation

6. **Team Coordination**: Notify team before starting backend machine restarts. Brief service interruption expected during startup.

---

## References

- Feature Specification: `specs/001-flyio-full-deployment/spec.md`
- Implementation Plan: `specs/001-flyio-full-deployment/plan.md`
- Quickstart Guide: `specs/001-flyio-full-deployment/quickstart.md`
- Research Documentation: `specs/001-flyio-full-deployment/research.md`
- Data Model: `specs/001-flyio-full-deployment/data-model.md`
- Constitution: `.specify/memory/constitution.md`
- Backend fly.toml: `backend/fly.toml`
- Frontend fly.toml: `fly.toml`
