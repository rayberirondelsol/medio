# Contract: nginx Cache Header Configuration
# Feature: 003-specify-scripts-bash
# Purpose: Define required nginx cache control headers to prevent deployment caching issues

# REQUIRED: Explicit no-cache block for index.html
# This block MUST appear BEFORE the static assets caching block
# to prevent index.html from being cached by browsers
location = /index.html {
    root /usr/share/nginx/html;

    # Force browsers to always check for new version
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;

    # Preserve security headers from main location block
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}

# EXISTING: Content-hashed static assets can be cached long-term
# These files have hashes in their names (e.g., main.ae51c1fa.chunk.js)
# so new deployments generate new file names
location ~* \.(css|js)$ {
    root /usr/share/nginx/html;
    expires 1y;
    add_header Cache-Control "public, immutable" always;
}

# EXISTING: Other static assets (images, fonts) - keep current caching
location ~* \.(jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
    root /usr/share/nginx/html;
    expires 1y;
    add_header Cache-Control "public, immutable" always;
}

# CRITICAL REQUIREMENT: Block order matters!
# 1. First: location = /index.html (exact match - highest priority)
# 2. Then: location ~* \.(css|js)$ (regex match for hashed chunks)
# 3. Last: location / (prefix match - lowest priority, SPA fallback)

# SUCCESS CRITERIA:
# - curl -I https://medio-react-app.fly.dev/index.html | grep "Cache-Control"
#   Must return: Cache-Control: no-cache, no-store, must-revalidate
#
# - curl -I https://medio-react-app.fly.dev/static/js/main.ae51c1fa.chunk.js | grep "Cache-Control"
#   Must return: Cache-Control: public, immutable
#
# - After deployment, new browser session loads updated index.html within 60 seconds
