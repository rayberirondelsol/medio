# Implementation Plan: Fix Video Modal Deployment and Functionality

**Branch**: `003-specify-scripts-bash` | **Date**: 2025-10-19 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-specify-scripts-bash/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Fix critical deployment caching and runtime issues preventing the Add Video Modal from functioning in production. Primary requirements: (1) Implement cache-busting to ensure browsers load updated frontend code after deployment, (2) Add defensive error handling so the modal never crashes when platforms API fails, (3) Coordinate frontend/backend deployments with clear documentation. Technical approach uses nginx cache headers, content-hashed assets (already generated by CRA), Error Boundaries around the modal, and defensive array initialization.

## Technical Context

**Language/Version**: TypeScript 4.9.5, React 19.1.1, Node.js 18
**Primary Dependencies**: Create React App (react-scripts 5.0.1), nginx (static serving), axios (HTTP client), React Context API (state management), Sentry (error tracking)
**Storage**: N/A (feature focuses on deployment and error handling, not data model changes)
**Testing**: Jest + React Testing Library (unit/integration), Playwright (E2E), ESLint (static analysis)
**Target Platform**: Modern web browsers (Chrome, Firefox, Safari, Edge) with JavaScript enabled
**Project Type**: Web application (React SPA frontend + Express.js backend API)
**Performance Goals**: <60 seconds deployment propagation to users, <3 seconds metadata fetch, 100% modal open success rate
**Constraints**: Must use CRA without ejecting, must work with existing Fly.io dual-app architecture (medio-react-app + medio-backend), must maintain httpOnly cookie authentication
**Scale/Scope**: Production web app serving family users, ~50 components, dual Fly.io deployment setup

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with Medio Constitution v1.0.0:

- [x] **Child Safety First**: Does this feature introduce any data collection from children? **NO** - Feature focuses on deployment infrastructure and error handling. No new data collection, no age-appropriate content concerns.
- [x] **Context-Driven Architecture**: Does this feature use React Context API only? **YES** - No new state management introduced. Uses existing React Context for auth/theme/loading. No Redux/Zustand/external state libraries.
- [x] **Test-First Development**: Are tests written and approved BEFORE implementation? **YES** - TDD workflow will be followed. Tests for Error Boundary, defensive array checks, and deployment verification will be written first.
- [x] **Error Resilience**: Are Error Boundaries planned? **YES** - Core focus of feature. Will wrap AddVideoModal with ErrorBoundary. Already added defensive array checks. AbortController cleanup for async operations will be verified. Graceful degradation via manual entry mode.
- [x] **Docker-First Development**: Can this feature be developed entirely in Docker? **YES** - Compatible with existing Docker setup. nginx configuration changes will be in Dockerfile. No host-specific dependencies introduced.
- [x] **NFC Security & Session Management**: If feature touches NFC or sessions, is server-side validation enforced? **N/A** - Feature does not touch NFC or session management.

**Technology Constraints Check**:
- [x] React 19 + TypeScript 4.9 + CRA (no ejecting) - **COMPLIANT** - No ejecting, uses existing CRA setup
- [x] Auth via httpOnly cookies only (no localStorage for tokens) - **COMPLIANT** - No auth changes, maintains existing httpOnly cookie system
- [x] Testing with Jest + React Testing Library + Playwright - **COMPLIANT** - All three frameworks will be used per TDD workflow
- [x] Sentry configured for error tracking - **COMPLIANT** - Will use existing Sentry integration for error logging

**Violations**: None

**Status**: ✅ ALL CONSTITUTION CHECKS PASSED - Cleared for Phase 0 research

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
backend/
├── src/
│   ├── routes/platforms.js          # Platform UUID endpoint (already public)
│   ├── middleware/rateLimiter.js    # Rate limiting for metadata API
│   └── config/
│       └── nginx.conf               # WILL ADD: Cache headers configuration
├── Dockerfile                       # WILL MODIFY: nginx cache header setup
└── fly.toml                         # Fly.io backend config (medio-backend app)

src/
├── components/
│   ├── common/
│   │   └── ErrorBoundary.tsx        # WILL CREATE: Error boundary wrapper
│   └── videos/
│       └── AddVideoModal.tsx        # WILL MODIFY: Wrap with ErrorBoundary, verify defensive code
├── utils/
│   ├── platformDetector.ts          # Platform detection (existing)
│   └── urlParser.ts                 # URL parsing (existing)
└── tests/
    ├── unit/
    │   └── components/
    │       └── ErrorBoundary.test.tsx    # WILL CREATE: TDD tests
    └── e2e/
        └── test-add-video-deployment.spec.js  # WILL CREATE: Deployment verification

.github/
└── workflows/
    └── fly.yml                      # WILL MODIFY: Add deployment verification step

Dockerfile                           # WILL MODIFY: Frontend nginx cache headers
fly.toml                             # Frontend config (medio-react-app app)
```

**Structure Decision**: Web application (frontend SPA + backend API). Frontend and backend are separate Fly.io apps requiring coordinated deployment. This feature primarily touches deployment infrastructure (Dockerfiles, nginx config) and error handling components (ErrorBoundary).

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**No violations detected.** This feature complies with all constitutional principles and technology constraints. No complexity tracking required.

