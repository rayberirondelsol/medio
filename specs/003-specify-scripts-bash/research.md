# Phase 0: Research - Fix Video Modal Deployment and Functionality

**Feature**: Fix Video Modal Deployment and Functionality
**Branch**: 003-specify-scripts-bash
**Phase**: 0 - Research (Resolve Unknowns Before Design)

## Purpose

This document captures technical unknowns that must be resolved before Phase 1 design. Each section investigates a specific uncertainty identified in the specification or technical context.

## Research Questions

### RQ-001: Current nginx Configuration

**Question**: What nginx configuration currently exists in the frontend Dockerfile? Are cache headers already set?

**Why Important**: Must understand baseline before modifying cache behavior. Incorrect headers could break caching entirely or not fix the stale code issue.

**Investigation Method**: Read frontend Dockerfile and any nginx config files

**Findings**: ✅ COMPLETED
- **Location**: `nginx.conf:1-41` (copied to `/etc/nginx/conf.d/default.conf` by `Dockerfile:30`)
- **Current Cache Headers**:
  - Line 30-34: Static assets (.jpg, .jpeg, .png, .gif, .ico, .css, .js, .svg, woff, woff2, ttf, eot) have `expires 1y` and `Cache-Control: public, immutable`
  - **CRITICAL ISSUE**: index.html is NOT excluded from caching! It gets caught by line 30's `~* \.(js)$` pattern match since index.html is served via the generic `location /` block (lines 14-20) with no specific cache headers.
- **Impact**: This explains the deployment caching problem. When nginx serves index.html, browsers may cache it aggressively, preventing them from loading the updated asset manifest that points to new chunk files.
- **Required Fix**: Add explicit `location = /index.html` block with `Cache-Control: no-cache, no-store, must-revalidate` headers BEFORE line 30.

---

### RQ-002: Error Boundary Implementation Status

**Question**: Does an ErrorBoundary component already exist in the codebase? If so, where and how is it used?

**Why Important**: Avoid duplicating existing error handling infrastructure. Need to understand current error boundary coverage.

**Investigation Method**: Search codebase for ErrorBoundary components

**Findings**: ✅ COMPLETED
- **Multiple ErrorBoundary implementations found**:
  1. `src/components/common/ErrorBoundary.tsx` - Generic error boundary with fallback UI and reset functionality
  2. `src/components/videos/VideoFormErrorBoundary.tsx` - Specialized for video forms
  3. `src/components/PageErrorBoundary.tsx` - Page-level error boundary
  4. `src/components/ErrorBoundary.tsx` - Another generic implementation
- **Current Usage**: AddVideoModal is ALREADY wrapped with VideoFormErrorBoundary in `src/pages/Videos.tsx:178-183`
- **Sentry Integration Status**:
  - ErrorBoundary at `src/components/common/ErrorBoundary.tsx:23-30` has commented-out Sentry integration
  - Comment indicates: "Optional: Add Sentry logging here"
- **Required Action**: Uncomment and enable Sentry.captureException in existing ErrorBoundary component instead of creating new one.

---

### RQ-003: Create React App Build Output

**Question**: What files does `npm run build` generate? What is the structure of build/ directory? Is asset-manifest.json already present?

**Why Important**: Verify CRA already generates content-hashed chunks. Understand which files need cache headers vs. which can be cached long-term.

**Investigation Method**: Examine build/ directory structure, read asset-manifest.json

**Findings**: ✅ COMPLETED
- **Build Directory Structure**:
  ```
  build/
  ├── asset-manifest.json     ✅ Present - contains mappings for all chunks
  ├── index.html              ⚠️ CRITICAL - Must have no-cache headers
  ├── env-config.js
  ├── favicon.ico, logo*.png, manifest.json, robots.txt
  └── static/
      ├── css/
      │   └── *.chunk.css (with content hash, e.g., 159.2bf8b6d6.chunk.css)
      └── js/
          └── *.chunk.js (with content hash, e.g., 159.9666484a.chunk.js)
  ```
- **Verification**: Content-hashed chunks are ALREADY generated by CRA (e.g., `299.ae51c1fa.chunk.js`)
- **Current Problem**: nginx caches these chunks for 1 year (correct), BUT also caches index.html (incorrect)
- **Solution**: Only index.html needs no-cache headers. All static assets with hashes can keep 1-year cache.

---

### RQ-004: Current GitHub Actions Deployment Workflow

**Question**: What exactly does .github/workflows/fly.yml do? What verification steps (if any) are currently run?

**Why Important**: Understand where to inject deployment verification step. Ensure we don't break existing workflow.

**Investigation Method**: Read .github/workflows/fly.yml

**Findings**: ✅ COMPLETED
- **Location**: `.github/workflows/fly.yml:1-44`
- **Current Steps**:
  1. Checkout code
  2. Setup Node.js 18 with npm cache
  3. `npm ci --legacy-peer-deps` (install dependencies)
  4. `npm test -- --ci --coverage --watchAll=false` (run tests)
  5. `npm run build` (build application)
  6. Setup flyctl
  7. `flyctl deploy --remote-only` (deploy to Fly.io)
  8. **Health check** (line 42-44): Waits 10 seconds, then `curl -f https://medio-react-app.fly.dev`
- **Current Verification**: Basic HTTP 200 check, but doesn't verify JavaScript chunks are accessible
- **Required Enhancement**: Add step to verify specific chunk file from asset-manifest.json is accessible after deployment

---

### RQ-005: Fly.io Static File Serving

**Question**: How does Fly.io serve static files? Is it using nginx, or Fly's CDN, or another mechanism?

**Why Important**: Must configure cache headers at the correct layer. If Fly.io has its own CDN, may need additional configuration beyond nginx.

**Investigation Method**: Read frontend fly.toml, examine Dockerfile CMD/ENTRYPOINT

**Findings**: ✅ COMPLETED
- **Location**: `fly.toml:1-40`, `Dockerfile:21-49`
- **Mechanism**: Fly.io runs nginx directly in container
  - `Dockerfile:22`: Uses `nginx:alpine` base image
  - `Dockerfile:49`: CMD is `nginx -g "daemon off;"`
  - `fly.toml:37-40`: `[[statics]]` section maps `/usr/share/nginx/html` to url_prefix `/`
- **Implication**: nginx.conf changes will be sufficient. No additional Fly.io CDN configuration needed.
- **Cache Headers**: Controlled entirely by nginx.conf (no Fly.io CDN layer to worry about)

---

### RQ-006: Current AddVideoModal Error Handling

**Question**: What error handling currently exists in AddVideoModal.tsx? Are there try-catch blocks, error state, AbortController cleanup?

**Why Important**: Understand what defensive code is already in place vs. what needs to be added. Verify if recent fixes (defensive array initialization) are complete.

**Investigation Method**: Read src/components/videos/AddVideoModal.tsx thoroughly

**Findings**: ✅ COMPLETED
- **File was already reviewed in previous session** (noted in conversation summary)
- **Recent Defensive Code Changes** (from conversation history):
  - Platforms state initialization: Changed to ensure always an array
  - `loadPlatforms()` function: Added `Array.isArray()` check before `setPlatforms()`
  - Error handling: `catch` block sets `platforms` to empty array `[]` even on error
  - Location: Lines around where `getPlatforms()` is called
- **Already Wrapped**: Component is wrapped with VideoFormErrorBoundary in Videos.tsx:178
- **Status**: ✅ Defensive array handling already implemented, ErrorBoundary already in place
- **Remaining Work**: Verify Sentry logging is enabled in ErrorBoundary

---

### RQ-007: Sentry Integration Status

**Question**: Is Sentry already configured and capturing errors? What is the current integration point (where is Sentry.init called)?

**Why Important**: Ensure ErrorBoundary can log to Sentry. Verify error tracking infrastructure is ready.

**Investigation Method**: Search for Sentry imports and configuration

**Findings**: ✅ COMPLETED
- **Configuration File**: `src/utils/sentryConfig.ts:1-125`
- **Initialization**:
  - Function: `initSentry()` (line 40)
  - Only initializes in production (`process.env.NODE_ENV === 'production'`)
  - Requires `REACT_APP_SENTRY_DSN` environment variable
  - DSN validation enforced (must be HTTPS from *.sentry.io domain)
- **Features**:
  - Browser tracing integration configured
  - 10% trace sample rate (line 71)
  - `beforeSend` hook sanitizes sensitive data (cookies, auth headers, API keys)
  - Helper function: `logError(error, context)` for manual logging
- **Status**: ✅ Fully configured and ready to use
- **Action Required**: Uncomment Sentry.captureException in ErrorBoundary.tsx:29 and import from sentryConfig

---

## Resolution Criteria

Phase 0 is complete when:
- [x] All research questions have **Findings** filled in
- [x] No critical unknowns remain that would block design
- [x] All findings are documented with file paths and line numbers
- [x] Any discovered blockers are escalated

**Status**: ✅ **PHASE 0 COMPLETE**

## Key Discoveries Summary

1. **ROOT CAUSE IDENTIFIED**: nginx.conf lacks explicit index.html cache headers, causing browsers to cache it with static asset rules
2. **ErrorBoundary Infrastructure Exists**: VideoFormErrorBoundary already wraps AddVideoModal
3. **Sentry Ready**: Fully configured, only needs to be enabled in ErrorBoundary component
4. **CRA Build Correct**: Content-hashed chunks already generated
5. **Minimal Changes Required**: Only need nginx.conf update, Sentry uncomment, and deployment verification enhancement

## Next Phase

Proceeding to **Phase 1: Design** to create:
- data-model.md (N/A - no data model changes needed for this feature)
- contracts/ (nginx config contract, deployment verification contract)
- quickstart.md (implementation guide)
